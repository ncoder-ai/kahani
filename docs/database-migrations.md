# Database Schema Management

Kahani uses Alembic exclusively for database schema management. This provides a clean, version-controlled approach to database changes.

## Architecture

### Pure Alembic Approach

- **Models** define the desired schema (source of truth for structure)
- **Alembic** generates migrations from model changes (version control)
- **Migrations** can recreate database from scratch or update existing ones
- **No hybrid approaches** - single source of truth

### How It Works

```
Fresh install:
  └─> alembic upgrade head
      └─> Runs ALL migrations from scratch
      └─> First migration creates all base tables
      └─> Subsequent migrations add new features

Existing install:
  └─> alembic upgrade head
      └─> Only runs NEW migrations since last version
```

## Creating a New Migration

When you need to change the database schema:

1. **Modify your model** in `backend/app/models/`
   ```python
   # Example: Add a new column to User model
   class User(Base):
       # ... existing fields ...
       email_verified = Column(Boolean, default=False)
   ```

2. **Generate migration** using autogenerate
   ```bash
   cd backend
   source ../.venv/bin/activate
   alembic revision --autogenerate -m "add email_verified to users"
   ```

3. **Review the generated file** in `backend/alembic/versions/`
   - Check that the changes look correct
   - Add any custom logic if needed
   - Test the migration on a copy of your data

4. **Apply the migration**
   ```bash
   alembic upgrade head
   ```

5. **Commit the changes**
   ```bash
   git add backend/alembic/versions/002_add_email_verified_to_users.py
   git commit -m "Add email_verified field to users"
   ```

## Fresh Database Setup

Simply run:
```bash
cd backend
alembic upgrade head
```

This will:
- Create all tables from scratch if database is new
- Apply only pending migrations if database exists

## Checking Status

- **Current version**: `alembic current`
- **Migration history**: `alembic history`
- **Pending migrations**: `alembic show head`
- **Available migrations**: `alembic heads`

## Development Workflow

### Adding a New Feature

1. **Design your model changes**
   - Add new fields, tables, relationships
   - Update existing models as needed

2. **Generate migration**
   ```bash
   alembic revision --autogenerate -m "add feature_name"
   ```

3. **Review and test**
   - Check the generated migration file
   - Test on a development database
   - Ensure data migration logic is correct

4. **Apply and commit**
   ```bash
   alembic upgrade head
   git add backend/alembic/versions/
   git commit -m "Add feature_name"
   ```

### Rolling Back Changes

If you need to undo a migration:

```bash
# Roll back one migration
alembic downgrade -1

# Roll back to specific version
alembic downgrade 001

# Roll back all migrations (careful!)
alembic downgrade base
```

## File Structure

```
backend/
├── alembic/
│   ├── env.py              # Alembic configuration
│   ├── alembic.ini         # Alembic settings
│   └── versions/
│       ├── 001_initial_schema.py
│       ├── 002_add_feature_x.py
│       └── 003_add_feature_y.py
├── app/
│   └── models/             # SQLAlchemy models (source of truth)
└── init_database_data.py   # Seeds default data (not schema)
```

## Best Practices

### Migration Guidelines

1. **Always review autogenerated migrations** before applying
2. **Test migrations on a copy of production data** when possible
3. **Use descriptive migration messages** that explain what changed
4. **Keep migrations small and focused** - one logical change per migration
5. **Never edit applied migrations** - create new ones instead

### Model Guidelines

1. **Keep models in sync with migrations** - don't let them drift
2. **Use nullable fields** for new columns that might have existing data
3. **Provide sensible defaults** for new fields
4. **Consider data migration** for complex schema changes

### Backup Strategy

Always backup before major schema changes:

```bash
cd backend
python backup_database.py create --reason "before_feature_x"
```

## Troubleshooting

### Common Issues

**Migration fails with "table already exists"**
- This usually means the database was created outside of Alembic
- Use `alembic stamp head` to mark current state as migrated

**Autogenerate doesn't detect changes**
- Ensure all models are imported in `backend/alembic/env.py`
- Check that `from app import models` is present

**Migration conflicts**
- Use `alembic merge` to resolve branch conflicts
- Or manually edit migration files to resolve dependencies

### Recovery

If migrations get into a bad state:

1. **Backup your data**
2. **Check current state**: `alembic current`
3. **Review migration history**: `alembic history`
4. **Reset to known good state**: `alembic downgrade <version>`
5. **Reapply migrations**: `alembic upgrade head`

## Production Deployment

### Safe Deployment Process

1. **Test migrations locally** on production data copy
2. **Backup production database** before deployment
3. **Deploy code** (but don't restart services yet)
4. **Run migrations**: `alembic upgrade head`
5. **Verify database state**: `alembic current`
6. **Restart services**

### Rollback Plan

If deployment fails:

1. **Stop services**
2. **Restore database backup**
3. **Revert code to previous version**
4. **Restart services**

## Migration History

Current migration chain:
- `001` - Initial database schema (all base tables)

Future migrations will be numbered sequentially as features are added.

---

**Remember**: Database schema changes are permanent and affect all users. Always test thoroughly and have a rollback plan!
